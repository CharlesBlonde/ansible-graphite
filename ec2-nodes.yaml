---
- name : EC2
  gather_facts: False
  hosts : localhost
  connection : local
  vars:
    - keyname: ansible
    - count : 30
    - instance_names:
      - chef-node-1-1
      - chef-node-1-2
      - chef-node-1-3
      - chef-node-2-1
      - chef-node-2-2
      - chef-node-2-3
      - chef-node-3-1
      - chef-node-3-2
      - chef-node-3-3
      - chef-node-4-1
      - chef-node-4-2
      - chef-node-4-3
      - chef-node-5-1
      - chef-node-5-2
      - chef-node-5-3
      - chef-node-6-1
      - chef-node-6-2
      - chef-node-6-3
      - chef-node-7-1
      - chef-node-7-2
      - chef-node-7-3
      - chef-node-8-1
      - chef-node-8-2
      - chef-node-8-3
      - chef-node-9-1
      - chef-node-9-2
      - chef-node-9-3
      - chef-node-10-1
      - chef-node-10-2
      - chef-node-10-3
    - instance_type: t1.micro
    - group : accept-all
    - ami : ami-8e987ef9 # Ubuntu server 12.04-LTS 64bit
    - ec2_url : ec2.eu-west-1.amazonaws.com
    - region : eu-west-1
    - dns_zone: aws.xebiatechevent.info
  gather_facts: False
  tasks:
    - name : Create EC2 Chef node instance(s)
      local_action: ec2 keypair={{keyname}} group={{group}} instance_type={{instance_type}} image={{ami}} wait=true ec2_url={{ec2_url}} region={{region}} count={{count}}
      register: ec2
    - name : Set EC2 Chef node tags
      local_action: ec2_tag ec2_url={{ec2_url}} region={{region}} resource={{item[0]}} state=present
      with_together:
        - ec2.instance_ids
        - instance_names
      args:
        tags:
          Name: "{{item[1]}}"
          Owner: "cblonde"
          Dns: "{{item[1}}.{{dns_zone}}"
    - name: Record Ansible Route53 DNS Chef nodes
      local_action : route53 command=create zone={{dns_zone}} record={{item[1]}}.{{dns_zone}} type=CNAME ttl=300 overwrite=yes value={{item[0].public_dns_name}}
      when : dns_zone is defined
      with_together:
        - ec2.instances
        - instance_names
    - name: Wait for SSH Chef nodes
      local_action: wait_for host={{item.public_dns_name}} port=22 delay=10 timeout=320 state=started
      with_items: ec2.instances



